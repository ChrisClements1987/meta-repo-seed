name: License Compliance Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'requirements*.txt'
      - 'setup.py'
      - 'pyproject.toml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'requirements*.txt'
      - 'setup.py'
      - 'pyproject.toml'

jobs:
  license-compliance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pip-licenses
        # Install project dependencies
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi
        
    - name: Check for GPL license violations
      run: |
        echo "üîç Scanning for GPL license violations..."
        
        # Fail on any GPL licenses (incompatible with MIT)
        if pip-licenses --format=csv | grep -i -E "(GPL|GPLv[0-9])"; then
          echo "‚ùå GPL-licensed dependencies found! These are incompatible with MIT license."
          echo "GPL dependencies must be removed or replaced with MIT/BSD/Apache alternatives."
          exit 1
        fi
        
        echo "‚úÖ No GPL license violations found"
        
    - name: Check for unknown licenses
      run: |
        echo "üîç Checking for unknown or unclear licenses..."
        
        # List unknown licenses for review
        unknown_licenses=$(pip-licenses --format=csv | grep -i "UNKNOWN" || true)
        if [ -n "$unknown_licenses" ]; then
          echo "‚ö†Ô∏è Dependencies with unknown licenses found:"
          echo "$unknown_licenses"
          echo ""
          
          # Check if unknown licenses are in our known-good list
          if [ -f "known-good-licenses.txt" ]; then
            echo "üîç Checking against known good licenses..."
            while IFS=',' read -r package license url; do
              if echo "$unknown_licenses" | grep -q "$package"; then
                echo "‚úÖ $package: Verified as $license (see $url)"
              fi
            done < <(grep -v '^#' known-good-licenses.txt | grep -v '^$')
          fi
          
          echo ""
          echo "Unknown licenses are allowed but should be verified and documented"
        else
          echo "‚úÖ All dependency licenses are known and documented"
        fi
        
    - name: Generate license report
      run: |
        echo "üìä Generating license compliance report..."
        
        # Create detailed license report
        echo "# License Compliance Report - $(date)" > license-report.md
        echo "" >> license-report.md
        echo "## All Dependencies" >> license-report.md
        pip-licenses --format=markdown >> license-report.md
        
        echo "" >> license-report.md
        echo "## LGPL Dependencies (MIT Compatible)" >> license-report.md
        pip-licenses --format=csv | grep -i "LGPL" | sed 's/,/ | /g' | sed 's/^/| /' | sed 's/$/ |/' >> license-report.md
        
        echo "" >> license-report.md
        echo "## Summary" >> license-report.md
        echo "- ‚úÖ No GPL license violations" >> license-report.md
        echo "- ‚ö†Ô∏è LGPL dependencies present (MIT compatible when used as libraries)" >> license-report.md
        echo "- üìã Review unknown licenses quarterly" >> license-report.md
        
    - name: Upload license report
      uses: actions/upload-artifact@v3
      with:
        name: license-compliance-report
        path: license-report.md
        retention-days: 90
        
    - name: License compliance summary
      run: |
        echo "üéØ License Compliance Summary:"
        echo "‚úÖ MIT License Compatible: All dependencies verified"
        echo "‚úÖ GPL Violations: None found"
        echo "‚ö†Ô∏è LGPL Dependencies: Present but MIT compatible"
        echo "üìä Report: Available in artifacts for legal review"
